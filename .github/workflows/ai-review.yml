name: AI Code Review

on:
    pull_request:
        types: [opened, synchronize, reopened]

permissions:
    pull-requests: write
    contents: read

jobs:
    review:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Start Ollama in background
              run: |
                  # Uruchamiamy Ollama w tle
                  docker run -d -p 11434:11434 --name ollama ollama/ollama:latest
                  
                  # Czekamy, aż Ollama wystartuje
                  for i in {1..15}; do
                    if curl -s http://localhost:11434/api/tags >/dev/null; then
                      echo "✅ Ollama działa"
                      break
                    fi
                    echo "⏳ Czekam na Ollama..."
                    sleep 3
                  done

            - name: Run AI review
              id: ai_review
              run: |
                  # Generujemy diff
                  DIFF=$(git diff origin/${{ github.base_ref }} --unified=0)
                  
                  # Wywołujemy Ollama
                  RAW=$(curl -s -X POST http://localhost:11434/api/generate \
                    -d "{\"model\":\"starcoder2:3b\",\"prompt\":\"Zrób szczegółowy, konstruktywny code review tego diffu, podzielone na sekcje: Plusy, Sugestie, Problemy krytyczne, Podsumowanie:\n$DIFF\",\"stream\":false}")
                  
                  echo "=== RAW RESPONSE ==="
                  echo "$RAW"
                  
                  # Wyciągamy odpowiedź
                  REVIEW=$(echo "$RAW" | jq -r '.resp
