name: AI Code Review

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    review:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # pobiera peÅ‚nÄ… historiÄ™ i wszystkie branche

            - name: Fetch base branch
              run: git fetch origin ${{ github.base_ref }}

            - name: Start Ollama container
              run: |
                  docker run -d --name ollama -p 11434:11434 ollama/ollama
                  sleep 5
                  docker exec ollama ollama pull starcoder2:3b

            - name: Run AI review
              id: ai_review
              run: |
                  DIFF=$(git diff origin/${{ github.base_ref }} --unified=0)
                  echo "=== CODE DIFF START ==="
                  echo "$DIFF"
                  echo "=== CODE DIFF END ==="
                  
                  REVIEW=$(curl -s -X POST http://localhost:11434/api/generate \
                    -d "{\"model\":\"starcoder2:3b\",\"prompt\":\"ZrÃ³b szczegÃ³Å‚owy, konstruktywny code review tego diffu:\n$DIFF\"}" \
                    | jq -r '.response')
                  
                  echo "review<<EOF" >> $GITHUB_OUTPUT
                  echo "$REVIEW" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Post AI review as PR comment
              uses: actions/github-script@v7
              with:
                  script: |
                      const review = process.env.REVIEW;
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.name,
                        issue_number: context.issue.number,
                        body: `ðŸ¤– **AI Code Review**\n\n${review}`
                      });
              env:
                  REVIEW: ${{ steps.ai_review.outputs.review }}
