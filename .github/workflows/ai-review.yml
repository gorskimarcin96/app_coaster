name: AI Code Review

on:
    pull_request:
        types: [ opened, synchronize, reopened ]

jobs:
    review:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout repo
                uses: actions/checkout@v4

            -   name: Install Ollama
                run: |
                    curl -fsSL https://ollama.com/install.sh | sh
                    ollama pull codellama:7b # model open-source do kodu

            -   name: Get PR diff
                id: diff
                run: |
                    git fetch origin ${{ github.base_ref }}
                    git diff origin/${{ github.base_ref }} --unified=0 > pr_diff.txt
                    echo "DIFF<<EOF" >> $GITHUB_ENV
                    cat pr_diff.txt >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV

            -   name: Run AI review locally
                id: ai_review
                run: |
                    RESPONSE=$(ollama run codellama:7b "Zrób code review poniższego diffu:\n\n${DIFF}")
                    echo "REVIEW=$RESPONSE" >> $GITHUB_ENV

            -   name: Comment on PR
                uses: actions/github-script@v7
                with:
                    github-token: ${{ secrets.GITHUB_TOKEN }}
                    script: |
                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: process.env.REVIEW
                        })
