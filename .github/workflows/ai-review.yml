name: AI Code Review

on:
    pull_request:
        types: [opened, synchronize, reopened]

permissions:
    pull-requests: write
    contents: read

jobs:
    review:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Start Ollama service container
              uses: addnab/docker-run-action@v3
              with:
                  image: ollama/ollama:latest
                  options: -d -p 11434:11434
                  run: |
                      echo "Sprawdzam dostƒôpne modele..."
                      curl -s http://localhost:11434/api/tags || echo "Brak odpowiedzi API"
                      # Pobierz model tylko je≈õli go nie ma
                      if ! curl -s http://localhost:11434/api/tags | grep -q "starcoder2:3b"; then
                        echo "Pobieram model starcoder2:3b..."
                        ollama pull starcoder2:3b
                      fi

            - name: Wait for Ollama to start
              run: |
                  for i in {1..15}; do
                    if curl -s http://localhost:11434/api/tags >/dev/null; then
                      echo "‚úÖ Ollama dzia≈Ça"
                      break
                    fi
                    echo "‚è≥ Czekam na Ollama..."
                    sleep 3
                  done

            - name: Run AI review
              id: ai_review
              run: |
                  DIFF=$(git diff origin/${{ github.base_ref }} --unified=0 | jq -Rs .)
                  
                  PAYLOAD=$(jq -n --arg diff "$DIFF" \
                    '{model:"starcoder2:3b", prompt: ("Zr√≥b szczeg√≥≈Çowy, konstruktywny code review tego diffu, podzielone na sekcje: Plusy, Sugestie, Problemy krytyczne, Podsumowanie:\n" + $diff), stream:false}')
                  
                  RAW=$(curl -s -X POST http://localhost:11434/api/generate \
                    -H "Content-Type: application/json" \
                    -d "$PAYLOAD")
                  
                  echo "=== RAW RESPONSE ==="
                  echo "$RAW"
                  
                  REVIEW=$(echo "$RAW" | jq -r '.response' | tr -d '\r')
                  
                  if [ -z "$REVIEW" ] || [ "$REVIEW" = "null" ]; then
                    REVIEW="‚ö†Ô∏è Model nie zwr√≥ci≈Ç ≈ºadnej odpowiedzi ‚Äì sprawd≈∫ logi."
                  fi
                  
                  echo "review<<EOF" >> $GITHUB_OUTPUT
                  echo "$REVIEW" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Post AI review as PR comment
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.payload.pull_request.number,
                        body: `ü§ñ **AI Code Review**\n\n${process.env.REVIEW}`
                      });
              env:
                  REVIEW: ${{ steps.ai_review.outputs.review }}
