name: AI Code Review

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    review:
        runs-on: ubuntu-latest

        services:
            ollama:
                image: ollama/ollama
                ports:
                    - 11434:11434
                options: >-
                    --health-cmd "curl -f http://localhost:11434/api/tags || exit 1"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4

            - name: Pull AI model
              run: |
                  curl -s -X POST http://localhost:11434/api/pull \
                    -d '{"name":"starcoder2:3b"}'

            - name: Run AI review
              run: |
                  DIFF=$(git diff origin/${{ github.base_ref }} --unified=0)
                  echo "=== CODE DIFF START ==="
                  echo "$DIFF"
                  echo "=== CODE DIFF END ==="
                  
                  RESPONSE=$(curl -s -X POST http://localhost:11434/api/generate \
                    -d "{\"model\":\"starcoder2:3b\",\"prompt\":\"Zrób szczegółowy code review tego diffu:\n$DIFF\"}" \
                    | jq -r '.response')
                  
                  echo "=== AI REVIEW ==="
                  echo "$RESPONSE"
